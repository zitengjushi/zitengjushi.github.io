name: Sync APK Files

on:
  schedule:
    - cron: '0 0 * * *'  # 每天 UTC 时间 00:00 运行
  workflow_dispatch:  # 允许手动触发

jobs:
  sync-apk:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 授予写入权限
    env:
      DEST_PATH: apk  # 定义在作业级别，所有步骤都可以使用
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      SOURCE_BRANCH: fongmi  # 指定源仓库分支
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install jq (JSON parser)
        uses: dcarbone/install-jq-action@v2

      - name: Install dependencies
        run: |
          pip install requests
          pip install PyGithub

      - name: Sync APK files
        run: python .github/scripts/sync_fongmi_apk.py
        env:
          SOURCE_REPO: FongMi/Release
          SOURCE_PATHS: apk,apk/release

      - name: Commit and push changes
        run: |
          echo "Current directory: $(pwd)"
          echo "GitHub workspace: $GITHUB_WORKSPACE"
          cd $GITHUB_WORKSPACE
          
          # 调试信息：检查目录结构和文件
          echo "Directory structure:"
          ls -la
          echo "APK directory:"
          ls -la ${DEST_PATH}/${SOURCE_BRANCH} 2>/dev/null || echo "Directory not found"
          echo "Scripts directory:"
          ls -la .github/scripts/ 2>/dev/null || echo "Directory not found"
          
          # 检查JSON文件是否存在
          if [ -f .github/scripts/fongmi_file_commit_info.json ]; then
            echo "Found JSON file:"
            cat .github/scripts/fongmi_file_commit_info.json
          else
            echo "JSON file not found"
            # 搜索JSON文件
            echo "Searching for JSON files:"
            find . -name "*.json" | grep -v "node_modules"
          fi
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # 检查文件状态
          echo "Git status:"
          git status
          
          # 检查是否有json文件包含文件提交信息
          if [ -f .github/scripts/fongmi_file_commit_info.json ]; then
            # 使用jq工具解析json文件（需要确保已安装jq）
            echo "Found file_commit_info.json, using per-file commit messages"
            
            # 获取所有文件列表
            FILES=$(jq -r 'keys[]' .github/scripts/fongmi_file_commit_info.json)
            
            # 为每个文件创建单独的提交
            for FILE in $FILES; do
              # 从FILE中提取子目录和文件名（格式：sub_dir/filename.apk）
              SUB_DIR=$(echo $FILE | cut -d'/' -f1)
              FILENAME=$(echo $FILE | cut -d'/' -f2-)
              
              # 获取文件的提交信息
              COMMIT_MESSAGE=$(jq -r --arg file "$FILE" '.[$file].commit_message' .github/scripts/fongmi_file_commit_info.json)
              
              # 如果提交信息为空或错误，使用默认信息
              if [[ -z "$COMMIT_MESSAGE" || "$COMMIT_MESSAGE" == "Error getting commit history" ]]; then
                COMMIT_MESSAGE="Update $FILENAME from source repository"
              fi
              
              # 构建完整文件路径
              FULL_FILE_PATH="${{ env.DEST_PATH }}/${{ env.SOURCE_BRANCH }}/$SUB_DIR/$FILENAME"
              
              # 检查文件是否存在
              if [ -f "$FULL_FILE_PATH" ]; then
                echo "Committing $SUB_DIR/$FILENAME with message: $COMMIT_MESSAGE"
                # 使用完整路径添加文件
                git add "$FULL_FILE_PATH"
                git commit -m "$COMMIT_MESSAGE"
              else
                echo "File not found: $FULL_FILE_PATH"
              fi
            done
            
            # 提交fongmi_file_commit_info.json文件以保留它
            if [ -f .github/scripts/fongmi_file_commit_info.json ]; then
              echo "Committing fongmi_file_commit_info.json to preserve it"
              git add .github/scripts/fongmi_file_commit_info.json
              git commit -m "Update file commit information json"
            fi
          else
            # 如果没有json文件，使用默认提交信息
            echo "No fongmi_file_commit_info.json found, using default commit message"
            git add ${{ env.DEST_PATH }}/${{ env.SOURCE_BRANCH }}/*
            git diff --cached --quiet || git commit -m "Update APK files from source repository"
          fi
          
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
